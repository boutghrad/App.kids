import 'package:flutter/material.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  MobileAds.instance.initialize();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'قصص الأطفال اليومية',
      theme: ThemeData(
        primarySwatch: Colors.amber,
        fontFamily: 'Cairo',
        textTheme: TextTheme(
          headline5: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
          bodyText1: TextStyle(fontSize: 18, height: 1.8),
        ),
      ),
      home: HomeScreen(),
      debugShowCheckedModeBanner: false,
    );
  }
}

class Story {
  final String id;
  final String title;
  final String imagePath;
  final String audioPath;
  final String content;
  bool isFavorite;
  bool isPremium;

  Story({
    required this.id,
    required this.title,
    required this.imagePath,
    required this.audioPath,
    required this.content,
    this.isFavorite = false,
    this.isPremium = false,
  });

  factory Story.fromJson(Map<String, dynamic> json) {
    return Story(
      id: json['id'],
      title: json['title'],
      imagePath: json['imagePath'],
      audioPath: json['audioPath'],
      content: json['content'],
      isPremium: json['isPremium'] ?? false,
    );
  }
}

class StoryService {
  Future<List<Story>> loadStories() async {
    return [
      Story(
        id: "1",
        title: "الأسد والفأر",
        imagePath: "assets/images/lion_mouse.jpg",
        audioPath: "assets/audio/lion_mouse.mp3",
        content: "في غابة بعيدة، عاش أسد قوي وفأر صغير. يومًا ما، وقع الفأر في مخالب الأسد، فتوسل إليه: \"أرجوك يا سيد الغابة، دعني أذهب وسأرد الجميل يوماً ما\". ضحك الأسد واستهزأ به لكنه تركه يذهب. بعد أيام، وقع الأسد في شباك صيادين، فسمع زئيره فأسرع الفأر وقرض الحبال وأنقذه. تعلم الأسد أن الصغير قد يكون مفيدًا، وأن الجميل يُرد بجميل.",
        isPremium: false,
      ),
      // باقي القصص هنا...
    ];
  }
}

class AdMobService {
  static String get bannerAdUnitId => 'ca-app-pub-3940256099942544/6300978111';
  static String get interstitialAdUnitId => "ca-app-pub-3940256099942544/1033173712";
  static String get rewardedAdUnitId => "ca-app-pub-3940256099942544/5224354917";
}

class HomeScreen extends StatefulWidget {
  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  List<Story> stories = [];
  List<Story> favoriteStories = [];
  bool isLoading = true;
  BannerAd? _bannerAd;
  int storyReadCount = 0;

  @override
  void initState() {
    super.initState();
    _initApp();
  }

  Future<void> _initApp() async {
    await loadStories();
    _loadBannerAd();
  }

  Future<void> _loadPreferences() async {
    final prefs = await SharedPreferences.getInstance();
    storyReadCount = prefs.getInt('storyReadCount') ?? 0;
    final favorites = prefs.getStringList('favorites') ?? [];
    
    setState(() {
      for (var story in stories) {
        story.isFavorite = favorites.contains(story.id);
      }
      favoriteStories = stories.where((s) => s.isFavorite).toList();
    });
  }

  Future<void> _savePreferences() async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setInt('storyReadCount', storyReadCount);
    prefs.setStringList('favorites', 
        stories.where((s) => s.isFavorite).map((s) => s.id).toList());
  }

  Future<void> loadStories() async {
    final storyService = StoryService();
    List<Story> loadedStories = await storyService.loadStories();
    setState(() {
      stories = loadedStories;
      isLoading = false;
    });
    await _loadPreferences();
  }

  void _loadBannerAd() {
    _bannerAd = BannerAd(
      adUnitId: AdMobService.bannerAdUnitId,
      request: AdRequest(),
      size: AdSize.banner,
      listener: BannerAdListener(
        onAdLoaded: (Ad ad) => print('Banner ad loaded.'),
        onAdFailedToLoad: (Ad ad, LoadAdError error) {
          ad.dispose();
          print('Banner ad failed to load: $error');
        },
      ),
    )..load();
  }

  void _showInterstitialAd() {
    InterstitialAd.load(
      adUnitId: AdMobService.interstitialAdUnitId,
      request: AdRequest(),
      adLoadCallback: InterstitialAdLoadCallback(
        onAdLoaded: (InterstitialAd ad) => ad.show(),
        onAdFailedToLoad: (LoadAdError error) {
          print('InterstitialAd failed to load: $error');
        },
      ),
    );
  }

  void _showRewardedAd(VoidCallback onReward) {
    RewardedAd.load(
      adUnitId: AdMobService.rewardedAdUnitId,
      request: AdRequest(),
      rewardedAdLoadCallback: RewardedAdLoadCallback(
        onAdLoaded: (RewardedAd ad) {
          ad.show(onUserEarnedReward: (_, __) => onReward());
        },
        onAdFailedToLoad: (LoadAdError error) {
          print('RewardedAd failed to load: $error');
        },
      ),
    );
  }

  void _handleStoryRead() {
    setState(() {
      storyReadCount++;
    });
    _savePreferences();
    
    if (storyReadCount % 3 == 0) {
      _showInterstitialAd();
    }
  }

  void _toggleFavorite(Story story) {
    setState(() {
      story.isFavorite = !story.isFavorite;
      if (story.isFavorite) {
        favoriteStories.add(story);
      } else {
        favoriteStories.removeWhere((s) => s.id == story.id);
      }
    });
    _savePreferences();
  }

  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: 2,
      child: Scaffold(
        appBar: AppBar(
          title: Text('قصص الأطفال اليومية'),
          bottom: TabBar(
            tabs: [
              Tab(icon: Icon(Icons.book)),
              Tab(icon: Icon(Icons.favorite)),
            ],
          ),
        ),
        body: TabBarView(
          children: [
            _buildStoryList(),
            _buildFavoritesList(),
          ],
        ),
        bottomNavigationBar: _bannerAd != null
            ? Container(
                height: _bannerAd!.size.height.toDouble(),
                width: _bannerAd!.size.width.toDouble(),
                child: AdWidget(ad: _bannerAd!),
              )
            : SizedBox(),
      ),
    );
  }

  Widget _buildStoryList() {
    if (isLoading) {
      return Center(child: CircularProgressIndicator());
    }

    return ListView.builder(
      itemCount: stories.length,
      itemBuilder: (context, index) {
        return _storyCard(stories[index]);
      },
    );
  }

  Widget _buildFavoritesList() {
    if (favoriteStories.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.favorite_border, size: 64, color: Colors.grey),
            SizedBox(height: 16),
            Text('لم تقم بإضافة قصص للمفضلة بعد'),
          ],
        ),
      );
    }

    return ListView.builder(
      itemCount: favoriteStories.length,
      itemBuilder: (context, index) {
        return _storyCard(favoriteStories[index]);
      },
    );
  }

  Widget _storyCard(Story story) {
    return Card(
      margin: EdgeInsets.all(8),
      elevation: 4,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: InkWell(
        onTap: () => _handleStoryTap(story),
        child: Column(
          children: [
            ClipRRect(
              borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
              child: Image.asset(
                story.imagePath,
                height: 150,
                width: double.infinity,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) => Container(
                  height: 150,
                  color: Colors.amber[100],
                  child: Icon(Icons.image, size: 50),
                ),
              ),
            ),
            ListTile(
              title: Text(story.title, style: Theme.of(context).textTheme.headline6),
              subtitle: story.isPremium 
                  ? Row(
                      children: [
                        Icon(Icons.star, color: Colors.amber, size: 16),
                        SizedBox(width: 4),
                        Text('قصة مميزة', style: TextStyle(color: Colors.amber)),
                      ],
                    )
                  : null,
              trailing: IconButton(
                icon: Icon(
                  story.isFavorite ? Icons.favorite : Icons.favorite_border,
                  color: story.isFavorite ? Colors.red : null,
                ),
                onPressed: () => _toggleFavorite(story),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _handleStoryTap(Story story) {
    if (story.isPremium) {
      _showRewardedAd(() {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => StoryDetailScreen(
              story: story,
              onRead: _handleStoryRead,
              onFavorite: () => _toggleFavorite(story),
            ),
          ),
        );
      });
    } else {
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => StoryDetailScreen(
            story: story,
            onRead: _handleStoryRead,
            onFavorite: () => _toggleFavorite(story),
          ),
        ),
      );
    }
  }
}

class StoryDetailScreen extends StatefulWidget {
  final Story story;
  final VoidCallback onRead;
  final VoidCallback onFavorite;

  StoryDetailScreen({
    required this.story,
    required this.onRead,
    required this.onFavorite,
  });

  @override
  _StoryDetailScreenState createState() => _StoryDetailScreenState();
}

class _StoryDetailScreenState extends State<StoryDetailScreen> {
  late AudioPlayer audioPlayer;
  bool isPlaying = false;
  bool hasRead = false;

  @override
  void initState() {
    super.initState();
    audioPlayer = AudioPlayer();
    audioPlayer.onPlayerStateChanged.listen((state) {
      setState(() => isPlaying = state == PlayerState.playing);
    });
  }

  @override
  void dispose() {
    audioPlayer.stop();
    audioPlayer.dispose();
    super.dispose();
  }

  void _toggleAudio() async {
    if (isPlaying) {
      await audioPlayer.pause();
    } else {
      await audioPlayer.play(AssetSource(widget.story.audioPath));
      if (!hasRead) {
        widget.onRead();
        hasRead = true;
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.story.title),
        actions: [
          IconButton(
            icon: Icon(
              widget.story.isFavorite ? Icons.favorite : Icons.favorite_border,
              color: widget.story.isFavorite ? Colors.red : null,
            ),
            onPressed: () {
              widget.onFavorite();
              setState(() {});
            },
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Hero(
              tag: 'image-${widget.story.id}',
              child: ClipRRect(
                borderRadius: BorderRadius.circular(12),
                child: Image.asset(
                  widget.story.imagePath,
                  height: 200,
                  width: double.infinity,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) => Container(
                    height: 200,
                    color: Colors.amber[100],
                    child: Icon(Icons.image, size: 50),
                  ),
                ),
              ),
            ),
            SizedBox(height: 20),
            Text(
              widget.story.content,
              style: Theme.of(context).textTheme.bodyText1,
              textAlign: TextAlign.justify,
            ),
            SizedBox(height: 30),
            FloatingActionButton(
              onPressed: _toggleAudio,
              child: Icon(isPlaying ? Icons.pause : Icons.volume_up),
              backgroundColor: Colors.amber,
            ),
            SizedBox(height: 20),
            Text(
              "اضغط على زر الصوت للاستماع للقصة",
              style: TextStyle(color: Colors.grey),
            ),
          ],
        ),
      ),
    );
  }
}
